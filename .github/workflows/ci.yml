name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test and Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy --all-targets -- -D warnings

    - name: Build
      run: cargo build --release

    - name: Run tests
      run: cargo test

    - name: Create artifact
      shell: bash
      run: |
        mkdir -p artifacts
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          cp target/release/ia-get.exe artifacts/
          cd artifacts && 7z a ia-get-${{ runner.os }}.zip ia-get.exe
        else
          cp target/release/ia-get artifacts/
          cd artifacts && tar czf ia-get-${{ runner.os }}.tar.gz ia-get
        fi

    - name: Calculate SHA256 hashes
      shell: bash
      run: |
        cd artifacts
        for file in *; do
          if [ -f "$file" ]; then
            sha256sum "$file" > "$file.sha256"
            echo "SHA256 for $file: $(cat "$file.sha256")"
          fi
        done

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ia-get-${{ runner.os }}
        path: artifacts/*
        retention-days: 30

  release:
    name: Create Development Release
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Prepare release artifacts
      run: |
        mkdir -p final-artifacts
        # Flatten artifact directory structure and calculate combined hashes
        find release-artifacts -type f -name "*.tar.gz" -o -name "*.zip" | while read file; do
          cp "$file" final-artifacts/
        done
        # Copy binaries but exclude .sha256 files from final artifacts
        find release-artifacts -type f -name "ia-get" -o -name "ia-get.exe" | while read file; do
          cp "$file" final-artifacts/
        done
        
        cd final-artifacts
        echo "## ðŸ“¦ Artifact Checksums (SHA256)" > ../HASHES.md
        echo "" >> ../HASHES.md
        # Generate hashes for the files in final-artifacts
        for file in *.tar.gz *.zip ia-get ia-get.exe; do
          if [ -f "$file" ]; then
            # Look for the corresponding .sha256 file in release-artifacts
            sha256_file=$(find ../release-artifacts -name "$file.sha256" -type f | head -1)
            if [ -f "$sha256_file" ]; then
              hash=$(cat "$sha256_file" | cut -d' ' -f1)
              echo "- **${file}**: \`${hash}\`" >> ../HASHES.md
            fi
          fi
        done

    - name: Generate release notes
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        COMMIT_MSG=$(git log -1 --pretty=format:'%s')
        DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        cat > RELEASE_NOTES.md << EOF
        # ðŸš€ Development Build - ${COMMIT_SHA}
        
        **Build Date**: ${DATE}  
        **Commit**: ${COMMIT_SHA}  
        **Message**: ${COMMIT_MSG}
        
        ## ðŸ“¥ Downloads
        
        Choose your platform:
        - **Linux**: \`ia-get-Linux.tar.gz\`
        - **Windows**: \`ia-get-Windows.zip\` 
        - **macOS**: \`ia-get-macOS.tar.gz\`
        
        $(cat HASHES.md)
        
        ## ðŸ“‹ Recent Changes
        
        $(head -n 50 CHANGELOG.md | tail -n +3)
        
        ---
        *This is an automated development build. For stable releases, see [tagged releases](https://github.com/Gameaday/ia-get-cli/releases).*
        EOF

    - name: Delete previous development release
      continue-on-error: true
      run: |
        gh release delete development --yes || true
        git push origin :refs/tags/development || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create development release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: development
        name: "ðŸ”§ Latest Development Build"
        body_path: RELEASE_NOTES.md
        files: final-artifacts/*
        prerelease: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}