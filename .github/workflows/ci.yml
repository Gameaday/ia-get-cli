name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Cancel previous runs when new commits are pushed to the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  # Optimize Cargo for CI/CD performance
  CARGO_NET_RETRY: 10
  CARGO_NET_TIMEOUT: 60
  CARGO_HTTP_TIMEOUT: 60
  CARGO_HTTP_LOW_SPEED_LIMIT: 10
  # Use offline mode when possible to prefer cached dependencies
  CARGO_NET_OFFLINE: false
  # Enable incremental compilation for faster builds
  CARGO_INCREMENTAL: 1

jobs:
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4.2.4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
        key: ${{ runner.os }}-cargo-audit-${{ hashFiles('**/Cargo.lock') }}

    - name: Install cargo-audit
      run: cargo install cargo-audit --locked

    - name: Run security audit
      run: cargo audit

    - name: Install cargo-outdated
      run: cargo install cargo-outdated --locked

    - name: Check for outdated dependencies
      run: cargo outdated --exit-code 1
      continue-on-error: true

  test:
    name: Test and Build (${{ matrix.os }}, ${{ matrix.features }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        features: [cli, gui]
        include:
          - features: cli
            feature_flags: "--no-default-features --features cli"
            cache_suffix: "cli"
          - features: gui  
            feature_flags: "--features gui"
            cache_suffix: "gui"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust toolchain
      uses: actions/cache@v4.2.4
      with:
        path: |
          ~/.rustup/toolchains
          ~/.rustup/update-hashes
          ~/.rustup/settings.toml
        key: ${{ runner.os }}-rustup-stable-${{ hashFiles('rust-toolchain.toml', 'Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-rustup-stable-
          ${{ runner.os }}-rustup-

    - name: Cache Cargo registry and dependencies
      uses: actions/cache@v4.2.4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
          # Windows-specific paths
          ${{ runner.os == 'Windows' && 'C:\Users\runneradmin\.cargo\registry\' || '' }}
          ${{ runner.os == 'Windows' && 'C:\Users\runneradmin\.cargo\git\' || '' }}
        key: ${{ runner.os }}-${{ matrix.cache_suffix }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.cache_suffix }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-${{ matrix.cache_suffix }}-cargo-
          ${{ runner.os }}-cargo-

    - name: Cache build artifacts by target
      uses: actions/cache@v4.2.4
      with:
        path: |
          target/debug/deps/
          target/debug/build/
          target/debug/.fingerprint/
          target/release/deps/
          target/release/build/
          target/release/.fingerprint/
        key: ${{ runner.os }}-${{ matrix.cache_suffix }}-target-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}-${{ hashFiles('build.rs') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.cache_suffix }}-target-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('src/**/*.rs') }}-
          ${{ runner.os }}-${{ matrix.cache_suffix }}-target-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-${{ matrix.cache_suffix }}-target-
          ${{ runner.os }}-target-

    - name: Warm up dependency cache (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        # Pre-fetch dependencies to populate cache
        cargo fetch --verbose
        # Verify cache integrity and show cache statistics
        echo "=== Cache Statistics ==="
        echo "Cargo cache size:"
        if command -v du > /dev/null 2>&1; then
          du -sh ~/.cargo/ 2>/dev/null || echo "Cache size check not available"
        else
          echo "Cache size check not available on this platform"
        fi
        echo "Target directory size:"
        if command -v du > /dev/null 2>&1; then
          du -sh target/ 2>/dev/null || echo "Target size check not available"
        else
          echo "Target size check not available on this platform"
        fi
        # Verify dependencies are available offline
        cargo tree --quiet > /dev/null 2>&1 || echo "Cache warming completed"

    - name: Warm up dependency cache (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Pre-fetch dependencies to populate cache
        cargo fetch --verbose
        # Verify cache integrity and show cache statistics
        Write-Host "=== Cache Statistics ==="
        Write-Host "Cargo cache size:"
        try {
          $cargoPath = if (Test-Path "$env:USERPROFILE\.cargo") { "$env:USERPROFILE\.cargo" } else { "~/.cargo" }
          if (Test-Path $cargoPath) {
            $size = (Get-ChildItem -Path $cargoPath -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
            Write-Host "Cache size: $([math]::Round($size / 1MB, 2)) MB"
          } else {
            Write-Host "Cache size check not available"
          }
        } catch {
          Write-Host "Cache size check not available"
        }
        Write-Host "Target directory size:"
        try {
          if (Test-Path "target") {
            $size = (Get-ChildItem -Path "target" -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
            Write-Host "Target size: $([math]::Round($size / 1MB, 2)) MB"
          } else {
            Write-Host "Target size check not available"
          }
        } catch {
          Write-Host "Target size check not available"
        }
        # Verify dependencies are available offline
        try { cargo tree --quiet *>$null } catch { Write-Host "Cache warming completed" }

    - name: Optimize cache for build speed (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        # Set environment variables for optimized builds
        echo "CARGO_NET_OFFLINE=true" >> $GITHUB_ENV
        echo "CARGO_TARGET_DIR=target" >> $GITHUB_ENV

    - name: Optimize cache for build speed (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Set environment variables for optimized builds
        "CARGO_NET_OFFLINE=true" | Add-Content -Path $env:GITHUB_ENV -Encoding UTF8
        "CARGO_TARGET_DIR=target" | Add-Content -Path $env:GITHUB_ENV -Encoding UTF8

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Run clippy
      run: cargo clippy ${{ matrix.feature_flags }} --all-targets -- -D warnings

    - name: Build (${{ matrix.features }} features)
      run: cargo build ${{ matrix.feature_flags }} --release

    - name: Run tests (${{ matrix.features }} features)
      run: cargo test ${{ matrix.feature_flags }}

    - name: Run build validation script (Windows only)
      if: runner.os == 'Windows' && matrix.features == 'gui'
      run: .\scripts\validate-build.ps1
      shell: pwsh

    - name: Create artifact (Unix)
      if: matrix.features == 'gui' && runner.os != 'Windows'
      shell: bash
      run: |
        # Ensure artifacts directory exists and is properly populated
        mkdir -p artifacts
        
        # Copy the binary (primary artifact)
        if [ -f "target/release/ia-get" ]; then
          # Check binary size before copying
          binary_size=$(stat -f%z "target/release/ia-get" 2>/dev/null || stat -c%s "target/release/ia-get" 2>/dev/null || echo "0")
          binary_size_mb=$((binary_size / 1024 / 1024))
          echo "📏 Binary size: ${binary_size_mb}MB (${binary_size} bytes)"
          
          # Verify binary is reasonable size (should be at least 1MB for a real binary)
          if [ "$binary_size" -lt 1048576 ]; then
            echo "❌ Binary is too small (${binary_size} bytes) - likely missing content"
            ls -la target/release/ || echo "Release directory not found"
            exit 1
          fi
          
          cp "target/release/ia-get" "artifacts/"
          echo "✅ Binary copied to artifacts"
        else
          echo "❌ Binary not found at target/release/ia-get"
          ls -la target/release/ || echo "Release directory not found"
          exit 1
        fi
        
        # Copy documentation files
        for doc_file in README.md LICENSE; do
          if [ -f "$doc_file" ]; then
            cp "$doc_file" "artifacts/"
            echo "✅ $doc_file copied to artifacts"
          fi
        done
        
        # List contents and sizes
        echo "📦 Artifacts directory contents:"
        ls -la artifacts/
        echo "📊 Artifacts total size:"
        du -sh artifacts/
        
        # Calculate hashes
        cd artifacts
        echo "# Calculated SHA256 hashes:" > ../hashes_${{ runner.os }}_${{ matrix.features }}.txt
        for file in *; do
          if [ -f "$file" ]; then
            if command -v sha256sum > /dev/null 2>&1; then
              hash=$(sha256sum "$file" | cut -d' ' -f1)
              echo "SHA256 for $file: $hash"
              echo "$hash  $file" >> ../hashes_${{ runner.os }}_${{ matrix.features }}.txt
            elif command -v shasum > /dev/null 2>&1; then
              hash=$(shasum -a 256 "$file" | cut -d' ' -f1)
              echo "SHA256 for $file: $hash"
              echo "$hash  $file" >> ../hashes_${{ runner.os }}_${{ matrix.features }}.txt
            else
              echo "SHA256 calculation not available for $file" >> ../hashes_${{ runner.os }}_${{ matrix.features }}.txt
            fi
          fi
        done
        cd ..
        
        # Create compressed archive for distribution
        PACKAGE_NAME="ia-get-${{ runner.os }}"
        echo "📦 Creating distribution archive: ${PACKAGE_NAME}.zip"
        cd artifacts && zip -r "../${PACKAGE_NAME}.zip" . && cd ..
        
        # Verify archive was created
        if [ -f "${PACKAGE_NAME}.zip" ]; then
          archive_size=$(stat -f%z "${PACKAGE_NAME}.zip" 2>/dev/null || stat -c%s "${PACKAGE_NAME}.zip" 2>/dev/null || echo "0")
          archive_size_mb=$((archive_size / 1024 / 1024))
          echo "✅ Archive created: ${PACKAGE_NAME}.zip (${archive_size_mb}MB)"
        else
          echo "❌ Failed to create archive"
          exit 1
        fi

    - name: Create artifact (Windows)
      if: matrix.features == 'gui' && runner.os == 'Windows'
      shell: pwsh
      run: |
        # Ensure artifacts directory exists and is properly populated
        New-Item -ItemType Directory -Path "artifacts" -Force | Out-Null
        
        # Copy the binary (primary artifact)
        if (Test-Path "target\release\ia-get.exe") {
          # Check binary size before copying
          $binarySize = (Get-Item "target\release\ia-get.exe").Length
          $binarySizeMB = [math]::Round($binarySize / 1MB, 2)
          Write-Host "📏 Binary size: ${binarySizeMB}MB ($binarySize bytes)"
          
          # Verify binary is reasonable size (should be at least 1MB for a real binary)
          if ($binarySize -lt 1048576) {
            Write-Host "❌ Binary is too small ($binarySize bytes) - likely missing content"
            if (Test-Path "target\release") {
              Get-ChildItem "target\release" | Format-Table Name, Length
            } else {
              Write-Host "Release directory not found"
            }
            exit 1
          }
          
          Copy-Item "target\release\ia-get.exe" "artifacts\"
          Write-Host "✅ Binary copied to artifacts"
        } else {
          Write-Host "❌ Binary not found at target\release\ia-get.exe"
          if (Test-Path "target\release") {
            Get-ChildItem "target\release" | Format-Table Name, Length
          } else {
            Write-Host "Release directory not found"
          }
          exit 1
        }
        
        # Copy documentation files
        $docFiles = @("README.md", "LICENSE")
        foreach ($docFile in $docFiles) {
          if (Test-Path $docFile) {
            Copy-Item $docFile "artifacts\"
            Write-Host "✅ $docFile copied to artifacts"
          }
        }
        
        # List contents and sizes
        Write-Host "📦 Artifacts directory contents:"
        Get-ChildItem "artifacts" | Format-Table Name, Length
        $totalSize = (Get-ChildItem "artifacts" -Recurse | Measure-Object -Property Length -Sum).Sum
        Write-Host "📊 Artifacts total size: $([math]::Round($totalSize / 1MB, 2)) MB"
        
        # Calculate hashes
        Set-Location "artifacts"
        "# Calculated SHA256 hashes:" | Out-File -FilePath "../hashes_${{ runner.os }}_${{ matrix.features }}.txt" -Encoding UTF8
        Get-ChildItem -File | ForEach-Object {
          $hash = (Get-FileHash -Path $_.Name -Algorithm SHA256).Hash.ToLower()
          Write-Host "SHA256 for $($_.Name): $hash"
          "$hash  $($_.Name)" | Add-Content -Path "../hashes_${{ runner.os }}_${{ matrix.features }}.txt" -Encoding UTF8
        }
        Set-Location ".."
        
        # Create compressed archive for distribution
        $packageName = "ia-get-${{ runner.os }}"
        $archivePath = "${packageName}.zip"
        Write-Host "📦 Creating distribution archive: $archivePath"
        
        try {
          Compress-Archive -Path "artifacts\*" -DestinationPath $archivePath -Force
          $archiveSize = (Get-Item $archivePath).Length
          $archiveSizeMB = [math]::Round($archiveSize / 1MB, 2)
          Write-Host "✅ Archive created: $archivePath (${archiveSizeMB}MB)"
        } catch {
          Write-Host "❌ Failed to create archive: $_"
          exit 1
        }

    - name: Upload artifact
      if: matrix.features == 'gui'
      uses: actions/upload-artifact@v4.6.2
      with:
        name: ia-get-${{ runner.os }}-${{ matrix.features }}
        path: |
          artifacts/*
          hashes_${{ runner.os }}_${{ matrix.features }}.txt
          ia-get-${{ runner.os }}.zip
        retention-days: 30

    - name: Cache cleanup and optimization
      if: always()
      shell: pwsh
      run: |
        # Clean up target directory to keep cache size manageable  
        try { cargo clean --target-dir target/debug } catch { Write-Host "Debug clean failed, continuing..." }
        
        # Remove old incremental compilation artifacts
        Get-ChildItem -Path target/ -Recurse -Directory -Name "incremental" -ErrorAction SilentlyContinue | ForEach-Object { 
            try { 
                Remove-Item -Path "target/$_" -Recurse -Force -ErrorAction SilentlyContinue
                Write-Host "Removed incremental cache: target/$_"
            } catch {
                Write-Host "Could not remove target/$_"
            }
        }
        
        Write-Host "Cache cleanup completed"

  android-build:
    name: Android APK & App Bundle Build (Development)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android NDK
      run: |
        echo "Installing Android NDK..."
        sdkmanager --install "ndk;27.3.13750724"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.3.13750724" >> $GITHUB_ENV
        echo "NDK installed at: $ANDROID_HOME/ndk/27.3.13750724"

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.0'
        channel: 'stable'
        cache: true

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

    - name: Install cargo-ndk
      run: cargo install cargo-ndk

    - name: Cache Android dependencies
      uses: actions/cache@v4.2.4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
          ~/.android
          ~/.pub-cache
        key: ${{ runner.os }}-android-apk-dart3.8-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('mobile/**/Cargo.toml') }}-${{ hashFiles('mobile/**/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-android-apk-dart3.8-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('mobile/**/Cargo.toml') }}-
          ${{ runner.os }}-android-apk-dart3.8-${{ hashFiles('**/Cargo.lock') }}-
          ${{ runner.os }}-android-apk-dart3.8-

    - name: Verify Flutter and Dart versions
      run: |
        flutter --version
        flutter doctor -v
        echo "Verifying Dart SDK version is 3.8.0 or higher..."
        DART_VERSION=$(flutter --version | grep "Dart" | awk '{print $4}')
        echo "Detected Dart version: $DART_VERSION"

    - name: Flutter Code Analysis
      run: |
        cd mobile/flutter
        echo "Running flutter analyze..."
        flutter analyze --no-fatal-infos
        echo "✓ Flutter analysis passed"

    - name: Build Android APK and App Bundle
      run: |
        chmod +x scripts/build-mobile.sh
        
        # Build development App Bundle for testing Play Store format
        ./scripts/build-mobile.sh --development --appbundle
        
        # Also build development APK for direct installation
        ./scripts/build-mobile.sh --development

    - name: Package Android artifacts
      run: |
        set -x  # Enable debug mode to see exactly where script fails
        
        # Create artifacts directory with error checking
        echo "🔍 Creating android-artifacts directory..."
        if ! mkdir -p android-artifacts; then
          echo "❌ ERROR: Failed to create android-artifacts directory"
          exit 1
        fi
        
        # Track what we actually find
        FOUND_ITEMS=0
        
        # Copy APK files with validation
        echo "🔍 Checking for target/mobile directory..."
        if [ -d "target/mobile" ]; then
          echo "✓ Found target/mobile directory"
          ls -la target/mobile/
          
          # Copy APK files with error checking
          echo "🔍 Checking for APK files..."
          if ls target/mobile/*.apk 1> /dev/null 2>&1; then
            echo "🔍 Copying APK files..."
            if ! cp target/mobile/*.apk android-artifacts/; then
              echo "❌ ERROR: Failed to copy APK files"
              exit 1
            fi
            APK_COUNT=$(ls target/mobile/*.apk | wc -l)
            echo "✓ Copied $APK_COUNT APK file(s)"
            FOUND_ITEMS=$((FOUND_ITEMS + APK_COUNT))
          else
            echo "❌ ERROR: No APK files found in target/mobile/"
            echo "Flutter APK build must have failed. Check build logs above."
            exit 1
          fi
          
          # Copy App Bundle files (AAB) with error checking
          echo "🔍 Checking for AAB files..."
          if ls target/mobile/*.aab 1> /dev/null 2>&1; then
            echo "🔍 Copying AAB files..."
            if ! cp target/mobile/*.aab android-artifacts/; then
              echo "❌ ERROR: Failed to copy AAB files"
              exit 1
            fi
            AAB_COUNT=$(ls target/mobile/*.aab | wc -l)
            echo "✓ Copied $AAB_COUNT App Bundle file(s)"
            FOUND_ITEMS=$((FOUND_ITEMS + AAB_COUNT))
          else
            echo "⚠ No App Bundle (.aab) files found in target/mobile/"
            echo "Note: App Bundle build may have been skipped (only required when --appbundle flag is used)"
          fi
        else
          echo "✗ target/mobile directory not found"
        fi
        
        # Copy native libraries for developers (check both possible locations)
        echo "🔍 Checking for native libraries..."
        if [ -d "target/mobile/android" ]; then
          echo "🔍 Copying native libraries from target/mobile/android..."
          if ! cp -r target/mobile/android android-artifacts/native-libs; then
            echo "❌ ERROR: Failed to copy native libraries from target/mobile/android"
            exit 1
          fi
          echo "✓ Copied native libraries from target/mobile/android"
          FOUND_ITEMS=$((FOUND_ITEMS + 1))
        elif [ -d "target/android" ]; then
          echo "🔍 Copying native libraries from target/android..."
          if ! cp -r target/android android-artifacts/native-libs; then
            echo "❌ ERROR: Failed to copy native libraries from target/android"
            exit 1
          fi
          echo "✓ Copied native libraries from target/android"
          FOUND_ITEMS=$((FOUND_ITEMS + 1))
        else
          echo "⚠ No native libraries found (checked target/mobile/android and target/android)"
        fi
        
        # Copy documentation with better error handling
        echo "🔍 Copying documentation files..."
        for doc_file in README.md LICENSE; do
          if [ -f "$doc_file" ]; then
            if cp "$doc_file" android-artifacts/; then
              echo "✓ Copied $doc_file"
            else
              echo "❌ WARNING: Failed to copy $doc_file (non-critical)"
            fi
          else
            echo "⚠ WARNING: $doc_file not found in current directory"
          fi
        done
        
        # Validate we have meaningful content and provide detailed summary
        echo "📦 Android artifacts summary:"
        if ! ls -la android-artifacts/; then
          echo "❌ ERROR: Failed to list android-artifacts directory"
          exit 1
        fi
        
        # Count different types of files found
        APK_FILES=$(find android-artifacts/ -name "*.apk" 2>/dev/null | wc -l || echo "0")
        AAB_FILES=$(find android-artifacts/ -name "*.aab" 2>/dev/null | wc -l || echo "0")
        NATIVE_LIB_DIRS=$(find android-artifacts/ -name "native-libs" -type d 2>/dev/null | wc -l || echo "0")
        
        echo "📊 Artifact breakdown:"
        echo "   - APK files: $APK_FILES"
        echo "   - AAB files: $AAB_FILES"
        echo "   - Native library sets: $NATIVE_LIB_DIRS"
        echo "   - Total items found: $FOUND_ITEMS"
        
        if [ $FOUND_ITEMS -eq 0 ]; then
          echo "❌ ERROR: No Android build artifacts were found!"
          echo "Expected to find APK/AAB files in target/mobile/ or native libraries"
          echo "Build may have failed. Check build logs above."
          echo "🔍 Current directory contents:"
          ls -la
          echo "🔍 Current working directory: $(pwd)"
          exit 1
        fi
        
        # Require at least APK files for development builds
        if [ $APK_FILES -eq 0 ]; then
          echo "❌ ERROR: No APK files were successfully built!"
          echo "Development builds require working APK files for testing."
          echo "Check the build logs above for Flutter build errors."
          exit 1
        fi
        
        # Create archive with error checking
        echo "🔍 Creating archive..."
        if ! cd android-artifacts; then
          echo "❌ ERROR: Failed to change to android-artifacts directory"
          exit 1
        fi
        
        if ! zip -r ../ia-get-android-dev.zip *; then
          echo "❌ ERROR: Failed to create zip archive"
          cd ..
          exit 1
        fi
        
        if ! cd ..; then
          echo "❌ ERROR: Failed to return to parent directory"
          exit 1
        fi
        
        # Validate archive was created
        echo "🔍 Validating archive..."
        if [ ! -f "ia-get-android-dev.zip" ]; then
          echo "❌ ERROR: Archive file was not created"
          exit 1
        fi
        
        # Validate archive size
        ARCHIVE_SIZE=$(stat -c%s "ia-get-android-dev.zip" 2>/dev/null || stat -f%z "ia-get-android-dev.zip" 2>/dev/null || echo "0")
        if [ "$ARCHIVE_SIZE" = "0" ]; then
          echo "❌ ERROR: Failed to determine archive size or archive is empty"
          exit 1
        fi
        
        ARCHIVE_SIZE_KB=$((ARCHIVE_SIZE / 1024))
        echo "📏 Archive size: ${ARCHIVE_SIZE_KB}KB"
        
        if [ $ARCHIVE_SIZE -lt 50000 ]; then  # Less than 50KB indicates likely empty/minimal content
          echo "⚠ WARNING: Archive seems small (${ARCHIVE_SIZE_KB}KB). Expected larger size for Android build."
        fi
        
        # Calculate hash with error checking
        echo "🔍 Calculating SHA256 hash..."
        if ! sha256sum ia-get-android-dev.zip > android-dev-hash.txt; then
          echo "❌ ERROR: Failed to calculate SHA256 hash"
          exit 1
        fi
        
        echo "✓ Created development Android artifact: ia-get-android-dev.zip (${ARCHIVE_SIZE_KB}KB)"
        echo "✓ Package Android artifacts step completed successfully"

    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: ia-get-android-dev
        path: |
          ia-get-android-dev.zip
          android-dev-hash.txt
        retention-days: 30

  release:
    name: Create Development Release
    runs-on: ubuntu-latest
    needs: [security, test, android-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v5
      with:
        path: release-artifacts
        pattern: ia-get-*  # Download both GUI and Android artifacts

    - name: Prepare release artifacts
      run: |
        mkdir -p final-artifacts
        # Flatten artifact directory structure and gather hash information
        find release-artifacts -type f -name "*.tar.gz" -o -name "*.zip" | while read file; do
          [ -f "$file" ] && cp "$file" final-artifacts/
        done
        # Copy binaries
        find release-artifacts -type f -name "ia-get" -o -name "ia-get.exe" | while read file; do
          [ -f "$file" ] && cp "$file" final-artifacts/
        done
        
        cd final-artifacts
        echo "## 📦 Artifact Checksums (SHA256)" > ../HASHES.md
        echo "" >> ../HASHES.md
        
        # Collect hashes from all hash files
        for hash_file in ../release-artifacts/*/hashes_*_gui.txt ../release-artifacts/*/android-dev-hash.txt; do
          if [ -f "$hash_file" ]; then
            # Read each line from the hash file and match with files in final-artifacts
            while IFS= read -r line; do
              if [[ "$line" =~ ^[a-f0-9]{64}[[:space:]]+(.+)$ ]]; then
                hash=$(echo "$line" | cut -d' ' -f1)
                filename=$(echo "$line" | cut -d' ' -f3-)
                if [ -f "$filename" ]; then
                  echo "- **${filename}**: \`${hash}\`" >> ../HASHES.md
                fi
              fi
            done < "$hash_file"
          fi
        done

    - name: Generate release notes
      run: |
        COMMIT_SHA=$(git rev-parse --short HEAD)
        COMMIT_MSG=$(git log -1 --pretty=format:'%s')
        DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
        
        cat > RELEASE_NOTES.md << EOF
        # 🚀 Development Build - ${COMMIT_SHA}
        
        **Build Date**: ${DATE}  
        **Commit**: ${COMMIT_SHA}  
        **Message**: ${COMMIT_MSG}
        
        ## 📥 Downloads
        
        Choose your platform:
        - **Linux**: \`ia-get-Linux.zip\`
        - **Windows**: \`ia-get-Windows.zip\` 
        - **macOS**: \`ia-get-macOS.zip\`
        - **🤖 Android**: \`ia-get-android-dev.zip\` (complete APK & App Bundle for testing)
        
        ### 📱 Android Development
        The Android package contains development artifacts:
        - **Development APK**: Ready to install on devices for testing (\`ia-get-mobile-development.apk\`)
        - **Development App Bundle**: Play Store format for testing upload flow (\`ia-get-mobile-development.aab\`)  
        - **Native Libraries**: FFI libraries for all major Android architectures
          - **ARM64** (arm64-v8a) - Modern devices
          - **ARMv7** (armeabi-v7a) - Older devices
          - **x86_64** - Intel emulators
          - **x86** - Legacy emulators
        
        $(cat HASHES.md)
        
        ## 📋 Recent Changes
        
        $(head -n 50 CHANGELOG.md | tail -n +3)
        
        ---
        *This is an automated development build. For stable releases, see [tagged releases](https://github.com/Gameaday/ia-get-cli/releases).*
        EOF

    - name: Delete previous development release
      continue-on-error: true
      run: |
        if gh release view development >/dev/null 2>&1; then
          gh release delete development --yes
        fi
        if git tag -l | grep -q "^development$"; then
          git push origin :refs/tags/development
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create development release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: development
        name: "🔧 Latest Development Build"
        body_path: RELEASE_NOTES.md
        files: final-artifacts/*
        prerelease: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}